<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>国境に押し寄せる群衆シミュレーション</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: system-ui, -apple-system, sans-serif;
      background: #1a1a2e;
      color: #eee;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
    }
    h1 {
      margin-bottom: 10px;
      font-size: 24px;
      color: #fff;
    }
    #game-container {
      position: relative;
      margin: 20px 0;
    }
    canvas {
      border: 2px solid #444;
      background: linear-gradient(to right, #1e3a5f 0%, #2a5298 40%, #3d3d3d 70%, #2d2d2d 100%);
      cursor: crosshair;
    }
    #ui {
      display: flex;
      gap: 20px;
      margin-top: 20px;
      width: 900px;
    }
    #stats {
      flex: 1;
      background: #16213e;
      padding: 15px;
      border-radius: 8px;
      border: 1px solid #0f3460;
    }
    .stat-row {
      display: flex;
      justify-content: space-between;
      margin: 8px 0;
      font-size: 14px;
    }
    .stat-label { color: #aaa; }
    .stat-value {
      font-weight: bold;
      padding: 2px 8px;
      border-radius: 4px;
      background: #0f3460;
    }
    .stat-value.critical { background: #c62828; color: #fff; }
    .stat-value.good { background: #2e7d32; color: #fff; }
    #controls {
      flex: 1;
      background: #16213e;
      padding: 15px;
      border-radius: 8px;
      border: 1px solid #0f3460;
    }
    #instructions {
      background: #0f3460;
      padding: 15px;
      border-radius: 6px;
      margin-bottom: 10px;
      font-size: 14px;
      line-height: 1.6;
    }
    #instructions h3 {
      margin-bottom: 8px;
      color: #64b5f6;
    }
    #queue-count {
      text-align: center;
      margin: 10px 0;
      font-size: 14px;
      color: #ffa726;
    }
    #game-timer {
      position: fixed;
      top: 20px;
      right: 20px;
      background: rgba(0,0,0,0.8);
      padding: 20px 30px;
      border-radius: 12px;
      border: 3px solid #ffa726;
      z-index: 100;
    }
    #game-timer.warning {
      border-color: #ff6b6b;
      animation: pulse 0.5s infinite;
    }
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
    #timer-display {
      font-size: 48px;
      font-weight: bold;
      color: #fff;
      text-align: center;
    }
    #timer-label {
      font-size: 14px;
      color: #aaa;
      text-align: center;
      margin-top: 5px;
    }
    .game-over {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0,0,0,0.95);
      padding: 40px;
      border-radius: 12px;
      border: 3px solid #c62828;
      text-align: center;
      z-index: 1000;
    }
    .game-over h2 {
      color: #ff6b6b;
      margin-bottom: 20px;
    }
  </style>
</head>
<body>
  <div id="game-timer">
    <div id="timer-display">30</div>
    <div id="timer-label">残り時間</div>
  </div>

  <h1>🌊 国境に押し寄せる群衆シミュレーション 🚧</h1>
  <p>左から海を渡ってきた人々が押し寄せます。受け入れるか拒否するか判断してください。</p>

  <div id="game-container">
    <canvas id="canvas" width="900" height="500"></canvas>
  </div>

  <div id="ui">
    <div id="stats">
      <h3>国家ステータス</h3>
      <div class="stat-row">
        <span class="stat-label">人口:</span>
        <span class="stat-value" id="population">100</span>
      </div>
      <div class="stat-row">
        <span class="stat-label">資源:</span>
        <span class="stat-value" id="resources">100</span>
      </div>
      <div class="stat-row">
        <span class="stat-label">幸福度:</span>
        <span class="stat-value" id="happiness">70</span>
      </div>
      <div class="stat-row">
        <span class="stat-label">多様性:</span>
        <span class="stat-value" id="diversity">30</span>
      </div>
      <div class="stat-row">
        <span class="stat-label">犯罪率:</span>
        <span class="stat-value" id="crime">10</span>
      </div>
      <div class="stat-row">
        <span class="stat-label">受入人数:</span>
        <span class="stat-value" id="accepted">0</span>
      </div>
      <div class="stat-row">
        <span class="stat-label">国境滞留:</span>
        <span class="stat-value" id="atBorder">0</span>
      </div>
    </div>

    <div id="controls">
      <div id="queue-count">待機中: 0人</div>
      <div id="instructions">
        <h3>操作方法</h3>
        <p>🖱️ <strong>左クリック</strong>: 漂流者を受け入れる</p>
        <p>⏳ <strong>無視</strong>: 国境付近に滞留</p>
        <p>📊 各漂流者の横にパラメータ効果が表示されます</p>
      </div>
    </div>
  </div>

  <script>
    // ============ 漂流者データ（100人以上） ============
    const MIGRANT_TYPES = [
      // 技能系
      { name: 'Lian', trait: '医師', risk: 1, effect: { population: 3, resources: 5, crime: 0, happiness: 3, diversity: 2 } },
      { name: 'Kiro', trait: '技術者', effect: { population: 2, resources: 8, crime: 0, happiness: 1, diversity: 1 } },
      { name: 'Elena', trait: '農業技師', effect: { population: 2, resources: 10, crime: 0, happiness: 2, diversity: 1 } },
      { name: 'Marcus', trait: '建築士', effect: { population: 2, resources: 6, crime: 0, happiness: 2, diversity: 1 } },
      { name: 'Sofia', trait: '教師', effect: { population: 1, resources: -2, crime: 0, happiness: 5, diversity: 3 } },
      { name: 'Ahmed', trait: '料理人', effect: { population: 1, resources: 3, crime: 0, happiness: 4, diversity: 2 } },
      { name: 'Yuki', trait: '看護師', effect: { population: 2, resources: 3, crime: 0, happiness: 3, diversity: 2 } },
      { name: 'Ivan', trait: '電気技師', effect: { population: 1, resources: 7, crime: 0, happiness: 1, diversity: 1 } },

      // 文化系
      { name: 'Mina', trait: '詩人', effect: { population: 1, resources: -2, crime: 0, happiness: 3, diversity: 5 } },
      { name: 'Raj', trait: '音楽家', effect: { population: 1, resources: -1, crime: 0, happiness: 4, diversity: 4 } },
      { name: 'Zara', trait: '画家', effect: { population: 1, resources: -1, crime: 0, happiness: 3, diversity: 5 } },
      { name: 'Omar', trait: '宗教指導者', effect: { population: 1, resources: -3, crime: -2, happiness: 2, diversity: 6 } },
      { name: 'Chen', trait: '哲学者', effect: { population: 1, resources: -2, crime: 0, happiness: 2, diversity: 4 } },

      // 家族・子供
      { name: 'Ravi', trait: '家族連れ(5人)', effect: { population: 5, resources: -8, crime: 1, happiness: 3, diversity: 2 } },
      { name: 'Ana', trait: '母子(2人)', effect: { population: 2, resources: -4, crime: 0, happiness: 2, diversity: 1 } },
      { name: 'Dmitri', trait: '家族連れ(3人)', effect: { population: 3, resources: -5, crime: 1, happiness: 2, diversity: 1 } },

      // リスク系
      { name: 'Doro', trait: '元兵士', effect: { population: 1, resources: 2, crime: 5, happiness: -3, diversity: 1 } },
      { name: 'Viktor', trait: '前科者', effect: { population: 1, resources: 1, crime: 8, happiness: -5, diversity: 0 } },
      { name: 'Sergei', trait: '密輸業者', effect: { population: 1, resources: 5, crime: 10, happiness: -4, diversity: 0 } },
      { name: 'Zeen', trait: '政治活動家', effect: { population: 1, resources: -2, crime: 3, happiness: -2, diversity: 7 } },

      // 高齢者・弱者
      { name: 'Elsa', trait: '高齢女性', effect: { population: 1, resources: -5, crime: 0, happiness: 1, diversity: 1 } },
      { name: 'Georg', trait: '高齢男性', effect: { population: 1, resources: -4, crime: 0, happiness: 1, diversity: 1 } },
      { name: 'Nina', trait: '障がい者', effect: { population: 1, resources: -6, crime: 0, happiness: 2, diversity: 2 } },

      // 特殊職
      { name: 'Hiro', trait: 'AI研究者', effect: { population: 1, resources: 12, crime: 0, happiness: 2, diversity: 3 } },
      { name: 'Greta', trait: '環境活動家', effect: { population: 1, resources: -3, crime: 1, happiness: 3, diversity: 8 } },
      { name: 'Leo', trait: 'ジャーナリスト', effect: { population: 1, resources: 0, crime: 2, happiness: 1, diversity: 6 } },
    ];

    // 100人以上になるよう複製・バリエーション生成
    const generateMigrants = () => {
      const migrants = [];
      for (let i = 0; i < 120; i++) {
        const base = MIGRANT_TYPES[i % MIGRANT_TYPES.length];
        migrants.push({
          ...base,
          id: i,
          name: base.name + (i >= MIGRANT_TYPES.length ? ` ${Math.floor(i / MIGRANT_TYPES.length) + 1}` : '')
        });
      }
      return migrants;
    };

    const MIGRANTS_DATA = generateMigrants();

    // ============ ゲームステート ============
    const state = {
      population: 100,
      resources: 100,
      happiness: 70,
      diversity: 30,
      crime: 10,
      accepted: 0
    };

    // ============ Canvas設定 ============
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const W = canvas.width;
    const H = canvas.height;

    // ============ 漂流者オブジェクト ============
    class Migrant {
      constructor(data) {
        this.data = data;
        this.x = Math.random() * 100 + 20;
        this.y = Math.random() * H;
        this.vx = Math.random() * 0.5 + 0.3;
        this.vy = (Math.random() - 0.5) * 0.2;
        this.r = 6;
        this.color = this.getColor();
        this.selected = false;
      }

      getColor() {
        if (this.data.effect.crime >= 8) return '#e53935'; // 危険
        if (this.data.effect.crime >= 5) return '#fb8c00'; // やや危険
        if (this.data.effect.resources >= 8) return '#43a047'; // 高技能
        if (this.data.effect.resources <= -5) return '#5e35b1'; // 弱者
        return '#1e88e5'; // 通常
      }

      update(migrants) {
        // 国境付近での減速と滞留
        const atBorder = this.x >= W - 200;

        // 群体運動：近くの漂流者との反発・整列
        let pushX = 0, pushY = 0;
        let count = 0;

        for (let other of migrants) {
          if (other === this) continue;
          const dx = this.x - other.x;
          const dy = this.y - other.y;
          const dist = Math.sqrt(dx * dx + dy * dy);

          if (dist < 30 && dist > 0) {
            pushX += dx / dist;
            pushY += dy / dist;
            count++;
          }
        }

        if (count > 0) {
          this.vx += pushX * 0.01;
          this.vy += pushY * 0.01;
        }

        // ランダムノイズ
        this.vx += (Math.random() - 0.5) * 0.05;
        this.vy += (Math.random() - 0.5) * 0.05;

        // 国境付近で大幅減速
        if (atBorder) {
          this.vx *= 0.95;
          this.vy *= 0.95;
          // 滞留時のランダム移動
          this.vx += (Math.random() - 0.5) * 0.1;
          this.vy += (Math.random() - 0.5) * 0.1;
        }

        // 速度制限
        const maxSpeed = atBorder ? 0.5 : 2;
        const speed = Math.sqrt(this.vx * this.vx + this.vy * this.vy);
        if (speed > maxSpeed) {
          this.vx = (this.vx / speed) * maxSpeed;
          this.vy = (this.vy / speed) * maxSpeed;
        }

        // 位置更新
        this.x += this.vx;
        this.y += this.vy;

        // 国境の壁で停止
        if (this.x > W - 110) {
          this.x = W - 110;
          this.vx = 0;
        }

        // 境界反射
        if (this.y < this.r || this.y > H - this.r) {
          this.vy *= -0.8;
          this.y = Math.max(this.r, Math.min(H - this.r, this.y));
        }
      }

      draw() {
        ctx.beginPath();
        ctx.arc(this.x, this.y, this.r, 0, Math.PI * 2);
        ctx.fillStyle = this.color;
        ctx.fill();

        // ホバー時のハイライト
        ctx.strokeStyle = '#fff';
        ctx.lineWidth = 1;
        ctx.stroke();

        // パラメータ表示
        const effects = [];
        const e = this.data.effect;
        if (e.population && e.population !== 0) effects.push(`人口${e.population > 0 ? '+' : ''}${e.population}`);
        if (e.resources && e.resources !== 0) effects.push(`資源${e.resources > 0 ? '+' : ''}${e.resources}`);
        if (e.happiness && e.happiness !== 0) effects.push(`幸福${e.happiness > 0 ? '+' : ''}${e.happiness}`);
        if (e.crime && e.crime !== 0) effects.push(`犯罪${e.crime > 0 ? '+' : ''}${e.crime}`);

        // 名前と職業
        ctx.fillStyle = '#fff';
        ctx.font = 'bold 11px sans-serif';
        ctx.fillText(this.data.name, this.x + 10, this.y - 8);

        ctx.fillStyle = '#64b5f6';
        ctx.font = '10px sans-serif';
        ctx.fillText(this.data.trait, this.x + 10, this.y + 3);

        // 効果
        ctx.fillStyle = '#ffa726';
        ctx.font = '9px sans-serif';
        ctx.fillText(effects.join(' '), this.x + 10, this.y + 13);
      }

      isAtBorder() {
        return this.x >= W - 150;
      }

      containsPoint(px, py) {
        const dx = this.x - px;
        const dy = this.y - py;
        return Math.sqrt(dx * dx + dy * dy) <= this.r + 5;
      }
    }

    // ============ ゲーム管理 ============
    let migrants = [];
    let migrantQueue = [];
    let spawnTimer = 0;
    let gameOver = false;
    let gameTimeLeft = 30 * 60; // 30秒 = 1800フレーム (60fps想定)

    function spawnMigrant() {
      if (migrantQueue.length > 0) {
        const data = migrantQueue.shift();
        migrants.push(new Migrant(data));
      }
    }

    function acceptMigrant(migrant) {
      if (!migrant) return;

      const data = migrant.data;
      for (let key in data.effect) {
        state[key] = Math.max(0, Math.min(200, state[key] + data.effect[key]));
      }
      state.accepted++;

      migrants = migrants.filter(m => m !== migrant);
      updateUI();
      checkGameOver();
    }

    function updateUI() {
      const atBorderCount = migrants.filter(m => m.isAtBorder()).length;

      document.getElementById('population').textContent = state.population;
      document.getElementById('resources').textContent = state.resources;
      document.getElementById('happiness').textContent = state.happiness;
      document.getElementById('diversity').textContent = state.diversity;
      document.getElementById('crime').textContent = state.crime;
      document.getElementById('accepted').textContent = state.accepted;
      document.getElementById('atBorder').textContent = atBorderCount;
      document.getElementById('queue-count').textContent = `待機中: ${migrantQueue.length}人 | 国境付近: ${migrants.length}人`;

      // 危機表示
      ['resources', 'happiness'].forEach(key => {
        const el = document.getElementById(key);
        if (state[key] < 20) el.classList.add('critical');
        else if (state[key] > 80) el.classList.add('good');
        else el.classList.remove('critical', 'good');
      });

      if (state.crime > 50) {
        document.getElementById('crime').classList.add('critical');
      } else {
        document.getElementById('crime').classList.remove('critical');
      }

      // 国境滞留の警告表示
      const atBorderEl = document.getElementById('atBorder');
      if (atBorderCount > 20) {
        atBorderEl.classList.add('critical');
      } else if (atBorderCount > 10) {
        atBorderEl.style.background = '#fb8c00';
      } else {
        atBorderEl.classList.remove('critical');
        atBorderEl.style.background = '';
      }
    }

    function checkGameOver() {
      if (state.resources <= 0 || state.happiness <= 0 || state.crime >= 100) {
        gameOver = true;
        showGameOver();
      }
    }

    function showGameOver() {
      const reason = state.resources <= 0 ? '資源枯渇' :
                     state.happiness <= 0 ? '社会崩壊' :
                     state.crime >= 100 ? '治安崩壊' : '不明';

      const div = document.createElement('div');
      div.className = 'game-over';
      div.innerHTML = `
        <h2>ゲームオーバー</h2>
        <p>原因: ${reason}</p>
        <p>受入人数: ${state.accepted}人</p>
        <button onclick="location.reload()" style="margin-top: 20px; padding: 10px 20px;">再スタート</button>
      `;
      document.body.appendChild(div);
    }

    function showTimeUpResult() {
      // スコア計算
      const score = state.accepted * 100 + state.population + state.resources + state.happiness + state.diversity - state.crime;

      let rank = 'E';
      if (score >= 1000) rank = 'S';
      else if (score >= 800) rank = 'A';
      else if (score >= 600) rank = 'B';
      else if (score >= 400) rank = 'C';
      else if (score >= 200) rank = 'D';

      const div = document.createElement('div');
      div.className = 'game-over';
      div.innerHTML = `
        <h2>タイムアップ！</h2>
        <p style="font-size: 24px; margin: 20px 0;">ランク: <span style="color: #ffd700; font-size: 36px;">${rank}</span></p>
        <p>受入人数: ${state.accepted}人</p>
        <p>最終スコア: ${score}点</p>
        <hr style="margin: 20px 0; border-color: #444;">
        <p>人口: ${state.population} | 資源: ${state.resources}</p>
        <p>幸福度: ${state.happiness} | 多様性: ${state.diversity}</p>
        <p>犯罪率: ${state.crime}</p>
        <button onclick="location.reload()" style="margin-top: 20px; padding: 10px 20px; background: #2e7d32; color: white; border: none; border-radius: 6px; font-size: 16px; cursor: pointer;">もう一度プレイ</button>
      `;
      document.body.appendChild(div);
    }

    // ============ 描画ループ ============
    function draw() {
      // 背景（海→国境）
      ctx.clearRect(0, 0, W, H);

      // 海
      const gradient = ctx.createLinearGradient(0, 0, W, 0);
      gradient.addColorStop(0, '#1e3a5f');
      gradient.addColorStop(0.4, '#2a5298');
      gradient.addColorStop(0.7, '#3d3d3d');
      gradient.addColorStop(1, '#2d2d2d');
      ctx.fillStyle = gradient;
      ctx.fillRect(0, 0, W, H);

      // 国境壁
      ctx.fillStyle = '#555';
      ctx.fillRect(W - 100, 0, 100, H);

      ctx.fillStyle = '#ff6b6b';
      ctx.font = 'bold 20px sans-serif';
      ctx.fillText('国境', W - 70, H / 2);

      // ゲート
      ctx.strokeStyle = '#ffd700';
      ctx.lineWidth = 3;
      ctx.strokeRect(W - 90, H / 2 - 50, 80, 100);

      // 漂流者描画
      migrants.forEach(m => m.draw());
    }

    function update() {
      if (gameOver) return;

      // ゲームタイマー更新
      gameTimeLeft--;
      const secondsLeft = Math.ceil(gameTimeLeft / 60);
      document.getElementById('timer-display').textContent = secondsLeft;

      // 残り10秒で警告
      const timerEl = document.getElementById('game-timer');
      if (secondsLeft <= 10) {
        timerEl.classList.add('warning');
      }

      // 時間切れ
      if (gameTimeLeft <= 0) {
        gameOver = true;
        showTimeUpResult();
        return;
      }

      // スポーン
      spawnTimer++;
      if (spawnTimer > 90 && migrantQueue.length > 0) {
        spawnMigrant();
        spawnTimer = 0;
      }

      // 漂流者更新
      migrants.forEach(m => m.update(migrants));

      updateUI();
    }

    function gameLoop() {
      update();
      draw();
      requestAnimationFrame(gameLoop);
    }

    // ============ イベント ============
    canvas.addEventListener('click', (e) => {
      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;

      // クリックした位置の漂流者を探す
      for (let migrant of migrants) {
        if (migrant.containsPoint(x, y)) {
          acceptMigrant(migrant);
          break;
        }
      }
    });

    // ============ 初期化 ============
    migrantQueue = [...MIGRANTS_DATA];
    updateUI();
    gameLoop();
  </script>
</body>
</html>
